<!-- e28b5936-39ff-4b25-8294-c7c58aaa759c 7b7e3799-1a73-46ac-a5c6-a7b48a8f3dfd -->
# PRD: Protocol-Aware Connection Handling

## Document Purpose

This PRD can be given to an agent along with [`packages/web/WORKBENCH_COMPONENTS_2.md`](packages/web/WORKBENCH_COMPONENTS_2.md) to implement clean, maintainable protocol handling in the AID Workbench.

---

## Current State

The workbench currently:

- Discovers agents via DNS TXT records (works for all 8 protocols)
- Attempts MCP handshake for `proto=mcp` agents
- Shows static guidance for non-MCP protocols
- Has some UX issues with auth error messages

### Problems

1. Auth error UI shows "Local CLI required" incorrectly for HTTPS MCP servers needing PAT
2. No actual connection attempt for A2A (just guidance)
3. Code is scattered across multiple files with mixed concerns
4. Protocol handling logic is inline, not modular

---

## Goals

1. **MCP**: Clean handshake with clear auth feedback (current behavior, improved UX)
2. **A2A**: Fetch and display Agent Card JSON (new functionality)
3. **Other protocols**: Show helpful guidance (no connection attempt)
4. **Architecture**: Modular, registry-based protocol handling
5. **Auth UX**: Clear, protocol-appropriate error messages

---

## Protocol Behavior Matrix

| Protocol | Connection Action | Success Display | Auth Required Display |

|----------|-------------------|-----------------|----------------------|

| `mcp` | MCP SDK handshake | Capabilities list | PAT/OAuth prompt |

| `a2a` | Fetch `/.well-known/agent.json` | Agent Card (skills, endpoints) | Card's auth requirements |

| `openapi` | None | Guidance + spec URL | N/A |

| `graphql` | None | Guidance + endpoint | N/A |

| `grpc` | None | Guidance + grpcurl command | N/A |

| `websocket` | None | Guidance + connection info | N/A |

| `local` | None | CLI command to run | N/A |

| `zeroconf` | None | mDNS browse instructions | N/A |

---

## Detailed Requirements

### 1. MCP Handling (Cleanup)

**Current behavior** (keep):

- Perform MCP SDK handshake via `/api/handshake`
- Return capabilities, server info, security snapshot

**Auth UX fixes needed**:

- If 401/403 and `auth=pat`: Show "This MCP server requires a Personal Access Token"
- If 401/403 and `auth=oauth2_device`: Show OAuth device flow guidance
- If 401/403 and URI is `npx:`/`docker:`: Show "Local CLI required"
- Remove incorrect "Local CLI required" for HTTPS URLs

**Key file**: [`packages/web/src/app/api/handshake/route.ts`](packages/web/src/app/api/handshake/route.ts)

### 2. A2A Handling (New)

**New behavior**:

- Fetch the Agent Card from the URI (typically `/.well-known/agent.json`)
- Parse and display: name, description, skills, auth requirements
- Show provider info if available

**Agent Card structure** (per A2A spec):

```typescript
interface AgentCard {
  name: string;
  description?: string;
  url: string;
  provider?: { organization: string; url?: string };
  skills?: Array<{ id: string; name: string; description?: string }>;
  authentication?: { schemes: string[]; credentials?: string };
}
```

**UI display**:

- Card header with agent name + provider
- Skills list (expandable)
- Authentication requirements callout
- Link to full card JSON

### 3. Other Protocols (Guidance Only)

Keep current behavior: return `ProtocolGuidance` object with:

- Title, description, next steps
- Optional command (for local)
- Optional docs URL

### 4. Auth Error Handling

Create clear decision tree:

```
needsAuth = true?
├── URI scheme is local (npx:, docker:, pip:)?
│   └── Show "Local CLI required" + command
├── auth field = 'pat'?
│   └── Show "PAT required" + input
├── auth field = 'oauth2_device'?
│   └── Show OAuth device flow + metadata if compliant
├── auth field = 'oauth2_code'?
│   └── Show "OAuth authorization required" + redirect hint
└── Default
    └── Show generic "Authentication required" + input
```

---

## Architecture Recommendations

### Protocol Registry

Create [`packages/web/src/lib/protocols/`](packages/web/src/lib/protocols/):

```
protocols/
  index.ts         # Registry, getProtocolHandler()
  types.ts         # ProtocolHandler, ProtocolResult, AgentCard
  handlers/
    mcp.ts         # MCP handshake logic
    a2a.ts         # A2A card fetch logic
    guidance.ts    # Generic guidance for other protocols
```

**ProtocolHandler interface**:

```typescript
interface ProtocolHandler {
  token: ProtocolToken;
  canConnect: boolean;
  handle(uri: string, options?: HandshakeOptions): Promise<ProtocolResult>;
}
```

### Component Decomposition

Split [`packages/web/src/components/workbench/tool-blocks.tsx`](packages/web/src/components/workbench/tool-blocks.tsx) into:

```
tool-blocks/
  index.tsx              # Re-exports
  discovery-block.tsx    # DNS discovery UI
  connection-block.tsx   # Protocol connection UI
  mcp-result.tsx         # MCP capabilities display
  a2a-card.tsx           # Agent Card display (new)
  protocol-guidance.tsx  # Guidance for other protocols
  auth-prompts/
    index.tsx
    pat-prompt.tsx
    oauth-prompt.tsx
    local-cli-notice.tsx
```

---

## Implementation Order

1. Fix auth error UX in current code (quick win)
2. Create protocol registry structure
3. Implement A2A card fetching in `/api/handshake`
4. Create `A2ACardView` component
5. Split `tool-blocks.tsx` into smaller components
6. Add tests for each protocol handler

---

## Files to Modify

| File | Changes |

|------|---------|

| `packages/web/src/app/api/handshake/route.ts` | Add A2A card fetching, improve auth detection |

| `packages/web/src/components/workbench/tool-blocks.tsx` | Split into smaller components |

| `packages/web/src/hooks/use-connection.ts` | Add `AgentCard` type |

| `packages/web/src/lib/protocols/` | New directory with registry |

---

## Testing

- MCP: Test with `supabase.agentcommunity.org` (needs PAT)
- A2A: Test with `a2a.agentcommunity.org` (mock card)
- Local: Test with `firecrawl.agentcommunity.org` (npx command)
- Guidance: Test with `graphql.agentcommunity.org`, `grpc.agentcommunity.org`

---

## Success Criteria

- [ ] MCP auth errors show appropriate message based on `auth` field
- [ ] A2A agents display fetched Agent Card with skills
- [ ] Other protocols show guidance (no false errors)
- [ ] Code is modular: adding new protocol requires 1 file
- [ ] No "Local CLI required" for HTTPS MCP servers

### To-dos

- [ ] Fix auth error UX - remove incorrect 'Local CLI required' for HTTPS
- [ ] Create protocol registry in src/lib/protocols/
- [ ] Implement A2A Agent Card fetching in /api/handshake
- [ ] Create A2ACardView component for displaying agent cards
- [ ] Split tool-blocks.tsx into smaller focused components
- [ ] Add tests for protocol handlers