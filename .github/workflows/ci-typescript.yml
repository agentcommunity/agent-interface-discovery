name: CI (TypeScript)
on:
  workflow_dispatch:
  push:
    branches: [main, feat/aid1.1-spec, feat/next16-react19-modernization]
  pull_request:
    branches: [main, feat/aid1.1-spec, feat/next16-react19-modernization]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      TURBO_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      TURBO_TEAM: ${{ secrets.VERCEL_TEAM_ID }}
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 8.15.0
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Check generated files are up-to-date
        run: |
          pnpm install --frozen-lockfile
          pnpm gen
          git diff --exit-code

      - name: Build JS
        run: |
          pnpm exec turbo run build \
            --filter=@agentcommunity/aid \
            --filter=@agentcommunity/aid-conformance \
            --filter=@agentcommunity/aid-doctor \
            --filter=@agentcommunity/aid-web \
            --filter=@agentcommunity/e2e-tests

      - name: Self-hosted standalone smoke (web)
        run: |
          pnpm -C packages/web build
          PORT=4010 HOSTNAME=127.0.0.1 node packages/web/.next/standalone/server.js &
          server_pid=$!
          trap "kill ${server_pid}" EXIT
          sleep 5
          curl -fsS http://127.0.0.1:4010/ > /dev/null

      # ---- Static Checks (Phase 2: Linting) -----------------------------
      # Now that all packages are built, the linter can find the type
      # declarations and will work correctly.
      - name: Lint (ESLint flat config)
        run: pnpm lint

      # ---- Testing Phase ------------------------------------------------
      - name: Test JS
        run: |
          pnpm exec turbo run test \
            --filter=@agentcommunity/aid \
            --filter=@agentcommunity/aid-conformance \
            --filter=@agentcommunity/aid-doctor \
            --filter=@agentcommunity/aid-web \
            --filter=@agentcommunity/e2e-tests

      # ---- Cross-Language Checks ----------------------------------------
      - name: E2E Tests
        run: pnpm e2e
      - name: E2E PKA (aid-doctor mock)
        run: pnpm -C packages/aid-doctor build && pnpm -C packages/e2e-tests run e2e:pka

  doctor-e2e-matrix:
    name: Doctor E2E (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 8.15.0
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Build aid and aid-doctor
        run: |
          pnpm install --frozen-lockfile
          pnpm exec turbo run build --filter="@agentcommunity/aid" --filter="@agentcommunity/aid-doctor"
